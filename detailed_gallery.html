<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/images/icon.png">        
    <title>Schody Poznań - Schody Nowy Tomyśl Raczkowiak Piotr</title>
    <meta name="description" content="Produkcja i projektowanie schodów drewnianych, stalowych i innych na zamówienie. Schody wewnętrzne, zewnętrzne, na wymiar.">
    <meta name="keywords" content="produkcja schodów, schody na zamówienie, schody drewniane, schody stalowe, projektowanie schodów, schody wewnętrzne, schody zewnętrzne, nowoczesne schody, schody kręcone, schody proste, schody na wymiar, schody do domu, montaż schodów, schody metalowe, schody drewniano-stalowe, schody Nowy Tomyśl, schody Poznań, schody Polska, schody dywanowe, schody półkowe, schody galeria">
    <meta name="robots" content="index, follow">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
     <style>
                   :root {
        --primary-color: #445d5a;
        --accent-color: #d9a566;
      }
        .card-img-top {
            height: 200px;
            object-fit: cover;
        }
        .product-card {
            transition: transform 0.3s;
            cursor: pointer;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .gallery-container {
            padding: 40px 0;
        }
        .back-btn {
            margin-bottom: 20px;
        }
        #productDetail {
            display: none;
        }
        #productGallery {
            display: block;
        }
        .detail-image {
            height: 300px;
            object-fit: cover;
            cursor: pointer;
            margin-bottom: 30px;
            transition: transform 0.3s;
        }
        .detail-image:hover {
            transform: scale(1.05);
        }
        .gallery-heading {
            margin-bottom: 30px;
        }
        #loadingIndicator {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .no-images-message {
            text-align: center;
            padding: 30px;
            font-size: 1.2rem;
            color: #6c757d;
        }
        .img-container {
            position: relative;
        }
        .error-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.1);
            color: #dc3545;
            text-align: center;
            padding-top: 40%;
        }
        .modal-img {
            max-height: 80vh;
            max-width: 100%;
            object-fit: contain;
        }
      .title {
        font-size: 3rem;
        color: var(--primary);
        text-align: center;
        font-weight: 700;
        margin: 30px 0;
        position: relative;
        display: inline-block;
      }

      .title::after {
        content: '';
        position: absolute;
        width: 80px;
        height: 3px;
        background-color: var(--accent-color);
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
      }     
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/images/logo.png" alt="Schody Raczkowiak Logo" class="img-fluid">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Strona Główna</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="o-nas.html">O Nas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="services.html">Usługi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="detailed_gallery.html">Galeria</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="kontakt.html">Kontakt</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container text-center my-3">
      <h2 class="title">Nasza Galeria</h2>
    </div>
        
    <div class="container gallery-container text-center">
        <!-- Main Product Gallery -->
        <div id="productGallery">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 product-grid" id="productGalleryContainer">
                <!-- Product cards will be dynamically generated here -->
            </div>
        </div>

        <!-- Product Detail Gallery -->
        <div id="productDetail">
            <button class="btn btn-secondary back-btn" onclick="showMainGallery()">← Cofnij do galerii</button>
            <h1 id="productTitle" class="text-center gallery-heading">Product Details</h1>
            <div id="loadingIndicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading images...</p>
            </div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="detailGallery">
                <!-- Detail images will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="Large preview" class="modal-img">
                </div>
            </div>
        </div>
    </div>
        
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row  justify-content-center align-items-center">
                 <div class="col-lg-6 d-flex justify-content-center align-items-center text-center">
                    &copy; Copyright 2025 Schody Poznań, Schody Nowy Tomyśl Piotr Raczkowiak.
                </div>
            </div>
        </div>
    </footer>
        
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
// Cache for storing which products we've already loaded
const loadedProducts = {};
let imageModal;
let currentlyLoading = false;
let observer;

// Initialize modal, gallery, and intersection observer
document.addEventListener('DOMContentLoaded', function() {
    imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    
    // Set up intersection observer for lazy loading
    setupIntersectionObserver();
    
    // Generate the product gallery dynamically
    loadProductGallery();
});

// Set up intersection observer for lazy loading
function setupIntersectionObserver() {
    observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const productCard = entry.target;
                const productId = productCard.dataset.productId;
                const img = productCard.querySelector('img');
                
                if (img.getAttribute('data-src')) {
                    img.src = img.getAttribute('data-src');
                    img.removeAttribute('data-src');
                }
                
                // Once the image is loaded, we can unobserve this element
                observer.unobserve(productCard);
            }
        });
    }, {
        root: null, // viewport
        rootMargin: '0px 0px 200px 0px', // load images when they're 200px from viewport
        threshold: 0.1 // trigger when at least 10% of the item is visible
    });
}

// Load and generate the main product gallery
function loadProductGallery() {
    const galleryContainer = document.getElementById('productGalleryContainer');
    
    // First check which product folders exist - but now in batches
    loadProductBatch(1, 10, galleryContainer);
}

// Load products in batches
function loadProductBatch(startIndex, batchSize, galleryContainer) {
    if (currentlyLoading) return;
    currentlyLoading = true;
    
    checkFolderBatch(startIndex, startIndex + batchSize - 1, function(availableFolders) {
        currentlyLoading = false;
        
        if (availableFolders.length === 0 && startIndex === 1) {
            galleryContainer.innerHTML = '<div class="col-12 no-images-message">No products available.</div>';
            return;
        }
        
        // Generate a card for each available folder
        availableFolders.forEach(folderId => {
            const productCard = createProductCard(folderId);
            galleryContainer.appendChild(productCard);
            
            // Observe this card for lazy loading
            observer.observe(productCard);
        });
        
        // If we found some folders in this batch, try loading the next batch when user scrolls near bottom
        if (availableFolders.length > 0) {
            setupScrollLoadTrigger(startIndex + batchSize, batchSize, galleryContainer);
        }
    });
}

// Set up scroll event listener to load more content when near bottom
function setupScrollLoadTrigger(nextStartIndex, batchSize, galleryContainer) {
    const loadMoreTrigger = document.createElement('div');
    loadMoreTrigger.id = `load-trigger-${nextStartIndex}`;
    loadMoreTrigger.style.height = '1px';
    loadMoreTrigger.style.width = '100%';
    loadMoreTrigger.style.visibility = 'hidden';
    galleryContainer.appendChild(loadMoreTrigger);
    
    const loadMoreObserver = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) {
            // Remove this trigger and load more content
            loadMoreObserver.disconnect();
            loadMoreTrigger.remove();
            loadProductBatch(nextStartIndex, batchSize, galleryContainer);
        }
    }, {
        rootMargin: '0px 0px 500px 0px' // Load more when 500px from bottom
    });
    
    loadMoreObserver.observe(loadMoreTrigger);
}

// Create a product card element with lazy loading
function createProductCard(productId) {
    const col = document.createElement('div');
    col.className = 'col';
    
    const card = document.createElement('div');
    card.className = 'card h-100 product-card';
    card.setAttribute('onclick', `showProductDetail(${productId})`);
    card.setAttribute('data-product-id', productId);
    
    const imgPath = `/images/stairs/${productId}/thumbnail.jpg`;
    
    card.innerHTML = `
        <img data-src="${imgPath}" class="card-img-top" alt="Product ${productId}" 
             src="/api/placeholder/400/320" loading="lazy">
        <div class="card-body">
            <h5 class="card-title">Schody #${productId}</h5>
        </div>
    `;
    
    col.appendChild(card);
    return col;
}

// Check which folders exist in a specific range
function checkFolderBatch(startIndex, endIndex, callback) {
    const availableFolders = [];
    let checkCount = 0;
    
    function checkComplete() {
        checkCount++;
        if (checkCount >= (endIndex - startIndex + 1)) {
            callback(availableFolders);
        }
    }
    
    // Check all folders in the range simultaneously
    for (let i = startIndex; i <= endIndex; i++) {
        checkSingleFolder(i, exists => {
            if (exists) {
                availableFolders.push(i);
            }
            checkComplete();
        });
    }
}

// Check if a single folder exists
function checkSingleFolder(folderId, callback) {
    const img = new Image();
    img.src = `/images/stairs/${folderId}/thumbnail.jpg`;
    
    // Set a timeout for the check
    const timeoutId = setTimeout(() => {
        callback(false);
    }, 3000);
    
    // Image loaded successfully - folder exists
    img.onload = function() {
        clearTimeout(timeoutId);
        callback(true);
    };
    
    // Image failed to load - folder doesn't exist or is empty
    img.onerror = function() {
        clearTimeout(timeoutId);
        callback(false);
    };
}

// Show product detail gallery
function showProductDetail(productId) {
    document.getElementById('productGallery').style.display = 'none';
    document.getElementById('productDetail').style.display = 'block';
    document.getElementById('productTitle').innerText = `Schody nr. ${productId}`;
    
    // Clear previous images
    document.getElementById('detailGallery').innerHTML = '';
    
    // If we've already loaded this product's images before, use the cached version
    if (loadedProducts[productId]) {
        displayCachedImages(productId);
    } else {
        // Otherwise, show loading indicator and load images
        document.getElementById('loadingIndicator').style.display = 'block';
        loadProductImages(productId);
    }
    
    // Update browser URL without page reload
    window.history.pushState({productId: productId}, "", `?product=${productId}`);
}

// Lazy load images in the detail view
function loadProductImages(productId) {
    // Initialize cache for this product
    loadedProducts[productId] = [];
    
    let imageCounter = 1;
    let loadedCount = 0;
    const detailGallery = document.getElementById('detailGallery');
    const containerObserver = new IntersectionObserver((entries, observer) => {
        if (entries[0].isIntersecting) {
            containerObserver.disconnect();
            startLoadingDetailImages(productId, 1, detailGallery);
        }
    });
    
    containerObserver.observe(detailGallery);
}

// Load detail images in batches
function startLoadingDetailImages(productId, startImageNumber, gallery) {
    // Try loading a batch of images
    loadDetailImageBatch(productId, startImageNumber, startImageNumber + 4, gallery, (nextStartNumber) => {
        if (nextStartNumber) {
            // If we successfully loaded images, try the next batch
            startLoadingDetailImages(productId, nextStartNumber, gallery);
        } else {
            // We've found all images
            document.getElementById('loadingIndicator').style.display = 'none';
            
            if (loadedProducts[productId].length === 0) {
                // No images were found
                gallery.innerHTML = '<div class="col-12 no-images-message">No images available for this product.</div>';
            }
        }
    });
}

// Load a batch of detail images
function loadDetailImageBatch(productId, startNumber, endNumber, gallery, callback) {
    let imagesFound = false;
    let checkCount = 0;
    
    function checkComplete() {
        checkCount++;
        if (checkCount >= (endNumber - startNumber + 1)) {
            if (imagesFound) {
                callback(endNumber + 1);
            } else {
                callback(null);
            }
        }
    }
    
    // Check all images in range
    for (let i = startNumber; i <= endNumber; i++) {
        checkDetailImage(productId, i, exists => {
            if (exists) {
                imagesFound = true;
                addDetailImage(productId, i, gallery);
            }
            checkComplete();
        });
    }
}

// Check if a detail image exists
function checkDetailImage(productId, imageNumber, callback) {
    const img = new Image();
    img.src = `/images/stairs/${productId}/${imageNumber}.jpg`;
    
    // Set a timeout for the check
    const timeoutId = setTimeout(() => {
        callback(false);
    }, 3000);
    
    // Image loaded successfully
    img.onload = function() {
        clearTimeout(timeoutId);
        callback(true);
    };
    
    // Image failed to load
    img.onerror = function() {
        clearTimeout(timeoutId);
        callback(false);
    };
}

// Add a detail image to the gallery
function addDetailImage(productId, imageNumber, gallery) {
    // Add to cache
    loadedProducts[productId].push({
        productId: productId,
        imageNumber: imageNumber
    });
    
    // Create and add element to gallery
    const detailImageCol = createImageElement(productId, imageNumber);
    gallery.appendChild(detailImageCol);
    
    // Set up lazy loading
    const img = detailImageCol.querySelector('img');
    const imgObserver = new IntersectionObserver((entries, observer) => {
        if (entries[0].isIntersecting) {
            img.src = img.getAttribute('data-src');
            img.removeAttribute('data-src');
            observer.unobserve(img);
        }
    }, {
        rootMargin: '0px 0px 200px 0px'
    });
    
    imgObserver.observe(img);
}

// Display cached images (avoids reloading)
function displayCachedImages(productId) {
    const cachedImages = loadedProducts[productId];
    const detailGallery = document.getElementById('detailGallery');
    
    if (cachedImages.length === 0) {
        detailGallery.innerHTML = '<div class="col-12 no-images-message">No images available for this product.</div>';
    } else {
        cachedImages.forEach(function(imageData) {
            const detailImageCol = createImageElement(imageData.productId, imageData.imageNumber);
            detailGallery.appendChild(detailImageCol);
            
            // Set up lazy loading for cached images too
            const img = detailImageCol.querySelector('img');
            const imgObserver = new IntersectionObserver((entries, observer) => {
                if (entries[0].isIntersecting) {
                    img.src = img.getAttribute('data-src');
                    img.removeAttribute('data-src');
                    observer.unobserve(img);
                }
            }, {
                rootMargin: '0px 0px 200px 0px'
            });
            
            imgObserver.observe(img);
        });
    }
    
    document.getElementById('loadingIndicator').style.display = 'none';
}

// Create image element for gallery with lazy loading
function createImageElement(productId, imageNumber) {
    const detailImageCol = document.createElement('div');
    detailImageCol.className = 'col';
    
    const detailCard = document.createElement('div');
    detailCard.className = 'card h-100';
    
    const imgPath = `/images/stairs/${productId}/${imageNumber}.jpg`;
    
    detailCard.innerHTML = `
        <div class="img-container">
            <img data-src="${imgPath}" src="/api/placeholder/400/320" class="card-img-top detail-image" 
                loading="lazy" alt="Schody nr. ${productId} - Zdjęcie nr. ${imageNumber}" 
                onclick="showImageModal('${imgPath}', 'Schody nr. ${productId} - Zdjęcie ${imageNumber}')">
        </div>
        <div class="card-body">
            <p class="card-text">Zdjęcie nr. ${imageNumber}</p>
        </div>
    `;
    
    detailImageCol.appendChild(detailCard);
    return detailImageCol;
}

// Show large image in modal
function showImageModal(imageSrc, imageAlt) {
    const modalImage = document.getElementById('modalImage');
    modalImage.src = imageSrc;
    modalImage.alt = imageAlt;
    
    document.getElementById('imageModalLabel').innerText = imageAlt;
    
    imageModal.show();
}

// Show main gallery
function showMainGallery() {
    document.getElementById('productDetail').style.display = 'none';
    document.getElementById('productGallery').style.display = 'block';
    
    // Update browser URL without page reload
    window.history.pushState({}, "", "detailed_gallery.html");
}

// Handle browser back button
window.onpopstate = function(event) {
    if (event.state && event.state.productId) {
        showProductDetail(event.state.productId);
    } else {
        showMainGallery();
    }
};

// Check URL parameters on page load
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('product');
    
    if (productId) {
        showProductDetail(parseInt(productId));
    }
};
    </script>
</body>
</html>